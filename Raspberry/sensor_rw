import database_orm as db

import threading
import datetime

import RPi.GPIO as GPIO
GPIO.setmode(GPIO.BCM)

def get_sensors():
    #further code
    for sensor in db.sensor.select(): #fetch all sensors from the sensor table
        #tree for the sensor type. The sensor Value is safed in the value variable
        if sensor.type == "GPIO":
            GPIO.setup(sensor.pin, GPIO.IN)
            value = GPIO.input(sensor.pin)

        #create a row in the sensorValue table and saves it
        dbwrite = db.sensorValue(sensor_id=sensor.id, value=value, timestamp=datetime.datetime.now())
        dbwrite.save()

#create a thread for actualizing the sensor values in the database
x = threading.Thread(target=get_sensors)


num = 0 #variable for testing. start the thread only once
try:
    if num == 0: #push by the webserver
        x.start()
        num += 1

except(KeyboardInterrupt, SystemExit):
    print("Interrupted by user. Shutting down...")
    x.join()
    GPIO.cleanup()